<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" href="/static/Logo VariaTap.png" type="image/png">
  <meta charset="UTF-8" />
  <title>VariaTap â€” ConfiguraciÃ³n de Tarjeta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#6c63ff; --accent:#25d366; --bg:#0f1020; --text:#e9e9ef; --muted:#b9bbd3;
      --panel: rgba(255,255,255,.06); --panel2: rgba(255,255,255,.02); --border: rgba(255,255,255,.08);
      --ring: 0 0 0 3px rgba(108,99,255,.18);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;
      background: radial-gradient(1200px 600px at 20% 0%, #1a1b35, #0f1020);
      color:var(--text);
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    a{color:#c7c9ff}
    header{padding:28px 18px 10px; text-align:center}
    header img{width:120px; height:auto; display:block; margin:0 auto 10px; filter: drop-shadow(0 6px 16px rgba(0,0,0,.35))}
    header h1{margin:6px 0 4px; font-weight:800; letter-spacing:.2px}
    header p{margin:0; color:var(--muted)}

    .wrap{max-width:840px; margin:24px auto 40px; padding:0 16px}
    .panel{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:22px;
      box-shadow:0 10px 30px rgba(0,0,0,.28);
    }
    .panel h2{margin:0 0 4px; font-size:1.5rem}
    .panel p.lead{margin:0 0 14px; color:var(--muted)}

    form .field{margin:14px 0}
    label{display:block; margin:0 0 8px; color:var(--muted); font-size:.95rem}

    /* âœ… Agregamos input[type=url] para que los campos de redes luzcan igual */
    input[type=text],
    input[type=email],
    input[type=file],
    input[type=tel],
    input[type=url],
    select,
    textarea{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(8,10,24,.6);
      color:var(--text);
      outline:none;
    }
    input[type=text]:focus,
    input[type=email]:focus,
    input[type=file]:focus,
    input[type=tel]:focus,
    input[type=url]:focus,
    select:focus,
    textarea:focus{
      box-shadow: var(--ring);
    }

    fieldset{margin:18px 0; border:1px dashed rgba(255,255,255,.18); border-radius:14px; padding:12px}
    fieldset legend{color:var(--muted); padding:0 6px}

    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .grid-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
    @media (max-width:720px){ .grid-2,.grid-3{grid-template-columns:1fr} }

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:16px}
    .btn{display:inline-flex; align-items:center; gap:10px; text-decoration:none; padding:14px 18px; border-radius:14px; font-weight:700; border:1px solid rgba(255,255,255,.12)}
    .btn.primary{background:var(--accent); color:#0a120e; box-shadow:0 10px 24px rgba(37,211,102,.35)}
    .btn.secondary{background:rgba(255,255,255,.08); color:var(--text)}
    .btn:hover{transform:translateY(-1px); transition:transform .15s ease, filter .15s ease}

    .muted{color:var(--muted); font-size:.9rem}
    .hint{margin-top:6px; color:var(--muted); font-size:.85rem}

    footer{text-align:center; padding:28px 12px; color:var(--muted); font-size:.95rem}

    /* âœ… Solo visual: temas en mayÃºsculas sin cambiar los valores enviados al backend */
    #theme option { text-transform: uppercase; }
  </style>
</head>

<body>
  <header>
    <img src="/static/brand/variataplogofull-white.png" alt="VariaTap">
    <h1>VariaTap</h1>
    <p>Configura tu tarjeta NFC</p>
  </header>

  <div class="wrap">
    <div class="panel">
      <h2>{{ 'Editar tarjeta' if mode=='edit' else 'Crear tarjeta' }}</h2>
      <p class="lead">Slug: <strong>{{ slug }}</strong></p>
      
      {% if error %} <div style=" margin:12px 0; padding:12px 14px; border-radius:12px; background: rgba(255,0,0,.08); border: 1px solid rgba(255,0,0,.25); color: #ffb3b3;"> {{ error }} </div> {% endif %}
      
      <!-- Mensajes (colÃ³calo justo arriba del form) -->
      <div id="msg" style="display:none;margin:12px 0;padding:12px 14px;border-radius:12px;
        background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);font-weight:600;"
        role="alert" aria-live="polite"></div>

      <form id="cfgForm"
            method="post"
            action="{% if mode == 'edit' %}{{ url_for('edit_form', slug=slug) }}{% else %}{{ url_for('setup', slug=slug) }}{% endif %}"
            enctype="multipart/form-data"
            novalidate
            onsubmit="return validateEmails(event)">

        {% if mode == "edit" %}
          <input type="hidden" name="token" value="{{ token }}">
        {% endif %}

        <div class="field">
          <label for="name">Nombre *</label>
          <input id="name" name="name" type="text" placeholder="Tu nombre" required
                 value="{{ cfg.name if cfg else '' }}">
          <div class="hint">El <strong>tÃ­tulo</strong> se establecerÃ¡ automÃ¡ticamente igual al <strong>nombre</strong>.</div>
        </div>

        <div class="field">
          <label for="subtitle">SubtÃ­tulo</label>
          <input id="subtitle" name="subtitle" type="text" placeholder="Empresa o frase"
                 value="{{ cfg.subtitle if cfg else '' }}">
        </div>

        <div class="grid-2">
          <div class="field" style="position:relative">
            <!-- âœ… Solo texto visible cambiado -->
            <label for="avatar">Profile Picture</label>
            <input id="avatar" name="avatar" type="file" accept="image/*">
            <input type="hidden" name="avatar_remove" id="avatar_remove" value="0">
            {% if cfg and cfg.avatar %}
              <div class="hint">Actual: <code>{{ cfg.avatar }}</code></div>
              <button
                type="button"
                id="btn-remove-avatar"
                aria-label="Quitar Profile Picture"
                title="Quitar Profile Picture"
                style="position:absolute;top:28px;right:10px;background:rgba(255,255,255,.1);
                      border:1px solid rgba(255,255,255,.2);border-radius:50%;width:32px;height:32px;
                      display:flex;align-items:center;justify-content:center;cursor:pointer;">
                âœ•
              </button>
            {% endif %}
          </div>

          <div class="field" style="position:relative">
            <label for="companyLogo">Logo de empresa</label>
            <input id="companyLogo" name="companyLogo" type="file" accept="image/*">
            <input type="hidden" name="companyLogo_remove" id="companyLogo_remove" value="0">
            {% if cfg and cfg.companyLogo %}
              <div class="hint">Actual: <code>{{ cfg.companyLogo }}</code></div>
              <button
                type="button"
                id="btn-remove-logo"
                aria-label="Quitar logo"
                title="Quitar logo"
                style="position:absolute;top:28px;right:10px;background:rgba(255,255,255,.1);
                      border:1px solid rgba(255,255,255,.2);border-radius:50%;width:32px;height:32px;
                      display:flex;align-items:center;justify-content:center;cursor:pointer;">
                âœ•
              </button>
            {% endif %}
          </div>

        <div class="grid-2">
          <div class="field">
            <label for="email">Correo *</label>
            <input id="email" name="email" type="email" required
                   value="{{ cfg.email if cfg else '' }}">
          </div>
          <div class="field">
            <label for="email_confirm">Confirmar correo *</label>
            <input id="email_confirm" name="email_confirm" type="email" required>
          </div>
        </div>

        <fieldset>
          <legend>TelÃ©fonos</legend>
          <div class="grid-3">
            <input name="phones.cell" type="tel" placeholder="Celular"
                   value="{{ cfg.phones.cell if cfg and cfg.phones and cfg.phones.cell else '' }}">
            <input name="phones.work" type="tel" placeholder="Trabajo"
                   value="{{ cfg.phones.work if cfg and cfg.phones and cfg.phones.work else '' }}">
            <input name="phones.home" type="tel" placeholder="Casa"
                   value="{{ cfg.phones.home if cfg and cfg.phones and cfg.phones.home else '' }}">
          </div>
        </fieldset>

        <fieldset>
          <legend>Redes Sociales</legend>

          <!-- Nota general (se mantiene) -->
          <p class="hint" style="margin-top:0">
            ðŸ”— Puedes pegar <strong>links completos</strong> o tu <code>@usuario</code> (lo convertimos a enlace) en:
            <strong>Instagram, X (Twitter), TikTok y YouTube</strong>.<br>
            ðŸ”’ En <strong>LinkedIn</strong> y <strong>Facebook</strong> debes pegar el <strong>enlace completo</strong> (no aceptamos <code>@usuario</code>).<br>
            âœ… Si tu enlace no trae <code>https://</code>, lo agregamos automÃ¡ticamente.
          </p>

          <div class="grid-2">
            <div class="field">
              <label for="socials.instagram">Instagram</label>
              <input id="socials.instagram" name="socials.instagram" type="url"
                    placeholder="@tu_usuario"
                    value="{{ cfg.socials.instagram if cfg and cfg.socials and cfg.socials.instagram else '' }}">
            </div>

            <div class="field">
              <label for="socials.x">X (Twitter)</label>
              <input id="socials.x" name="socials.x" type="url"
                    placeholder="@tu_usuario"
                    value="{{ cfg.socials.x if cfg and cfg.socials and cfg.socials.x else '' }}">
            </div>

            <div class="field">
              <label for="socials.tiktok">TikTok</label>
              <input id="socials.tiktok" name="socials.tiktok" type="url"
                    placeholder="@tu_usuario"
                    value="{{ cfg.socials.tiktok if cfg and cfg.socials and cfg.socials.tiktok else '' }}">
            </div>

            <div class="field">
              <label for="socials.youtube">YouTube</label>
              <input id="socials.youtube" name="socials.youtube" type="url"
                    placeholder="https://youtube.com/@tu_canal"
                    value="{{ cfg.socials.youtube if cfg and cfg.socials and cfg.socials.youtube else '' }}">
            </div>

            <div class="field">
              <label for="socials.linkedin">LinkedIn</label>
              <input id="socials.linkedin" name="socials.linkedin" type="url"
                    placeholder="https://www.linkedin.com/in/tu_usuario"
                    value="{{ cfg.socials.linkedin if cfg and cfg.socials and cfg.socials.linkedin else '' }}">
            </div>

            <div class="field">
              <label for="socials.facebook">Facebook</label>
              <input id="socials.facebook" name="socials.facebook" type="url"
                    placeholder="https://facebook.com/tu_usuario"
                    value="{{ cfg.socials.facebook if cfg and cfg.socials and cfg.socials.facebook else '' }}">
            </div>

            <div class="field">
              <label for="socials.website">Sitio web</label>
              <input id="socials.website" name="socials.website" type="url"
                    placeholder="tu-dominio.com (agregamos https://)"
                    value="{{ cfg.socials.website if cfg and cfg.socials and cfg.socials.website else '' }}">
            </div>

            <div class="field">
              <label for="socials.whatsapp">WhatsApp</label>
              <input id="socials.whatsapp" name="socials.whatsapp" type="url"
                    placeholder="+52 123 456 7890  (convertimos a wa.me/)"
                    value="{{ cfg.socials.whatsapp if cfg and cfg.socials and cfg.socials.whatsapp else '' }}">
            </div>
          </div>
        </fieldset>


        <div class="field">
          <label for="theme">Tema</label>
          <select id="theme" name="theme">
            {% set current_theme = (cfg.theme if cfg else 'indigo') | lower %}
            {% for t in [
              "default (dark glow)","ocean","sunset","forest","mono",
              "silver","gold","lavender","rose","mint",
              "teal","indigo","coral","cyberpunk"
            ] %}
              <option value="{{ t }}" {% if t|lower == current_theme %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
          </select>
          <div class="hint">
            ðŸ‘‰ <a href="https://variatap.com/ejemplo/tu-nombre" target="_blank" rel="noopener">Ver ejemplo de temas</a>
          </div>
          {% if mode != "edit" %}
          <div class="field">
            <label style="display:flex; gap:10px; align-items:flex-start">
              <input id="accept_terms" name="accept_terms" type="checkbox" required style="margin-top:3px;">
              <span>
                Acepto los
                <a href="{{ url_for('terms') }}" target="_blank" rel="noopener">TÃ©rminos y Condiciones</a>
                y el
                <a href="{{ url_for('privacy') }}" target="_blank" rel="noopener">Aviso de Privacidad</a>.
              </span>
            </label>
            <div class="hint">Necesario para crear tu tarjeta.</div>
          </div>
          {% endif %}

        </div>
        {% if mode == "edit" %}
        <div class="field">
          <label for="verify_code">CÃ³digo de verificaciÃ³n (enviado por email)</label>
          <input id="verify_code" name="verify_code" type="text" placeholder="000000">
        </div>
        {% endif %}

        <div class="actions">
          <button class="btn primary" type="submit">
            {% if mode == "edit" %}Guardar cambios{% else %}Crear tarjeta{% endif %}
          </button>
          <a class="btn secondary" href="https://variatap.com/ejemplo/tu-nombre" target="_blank" rel="noopener">
            Ver ejemplo
          </a>
        </div>
      </form>
    </div>
  </div>

  <footer>Â© 2025 VariaTap</footer>

  <script>
  (function () {
    const form = document.getElementById('cfgForm');
    if (!form) return;

    const msgBox = document.getElementById('msg');
    const submitBtn = form.querySelector('button[type="submit"]');

    // === NormalizaciÃ³n de redes sociales ===
    function ensureProtocol(url) {
      if (!url) return '';
      const u = url.trim();
      if (/^https?:\/\//i.test(u)) return u;
      return 'https://' + u.replace(/^\/+/, '');
    }

    function looksLikeUsername(s) {
      if (!s) return false;
      const v = s.trim();
      return !/^https?:\/\//i.test(v) && !/[\/\s]/.test(v) && !/\./.test(v);
    }

    function normalizeHandleOrUrl(raw, { base, allowAt = false }) {
      if (!raw) return '';
      let v = raw.trim();

      if (v.startsWith('@')) {
        v = v.substring(1);
        return base + (allowAt ? '@' : '') + v;
      }

      if (looksLikeUsername(v)) {
        return base + (allowAt ? '@' : '') + v;
      }

      // si no parece username, asumir que es URL y asegurar https
      return ensureProtocol(v);
    }

    function normalizeWhatsApp(raw) {
      if (!raw) return '';
      let v = raw.trim();

      if (/wa\.me/i.test(v)) return ensureProtocol(v);

      const apiMatch = v.match(/send\?phone=(\+?\d+)/i);
      if (apiMatch) {
        const digits = apiMatch[1].replace(/\D/g, '');
        return `https://wa.me/${digits}`;
      }

      const digits = v.replace(/\D/g, '');
      if (digits.length >= 10) {
        return `https://wa.me/${digits}`;
      }

      // Ãºltimo recurso: si parece URL sin protocolo, agregarlo
      return ensureProtocol(v);
    }

    /**
     * Normaliza y valida campos sociales.
     * Devuelve { ok: boolean, message?: string, focus?: HTMLElement }
     */
    function normalizeSocialFields(formEl) {
      const map = {
        // âœ… convierten @usuario a enlace
        'socials.instagram': { base: 'https://instagram.com/', allowAt: false, mode: 'handleOrUrl', label: 'Instagram' },
        'socials.x':         { base: 'https://x.com/',         allowAt: false, mode: 'handleOrUrl', label: 'X (Twitter)' },
        'socials.tiktok':    { base: 'https://tiktok.com/',    allowAt: true,  mode: 'handleOrUrl', label: 'TikTok' },
        'socials.youtube':   { base: 'https://youtube.com/',   allowAt: true,  mode: 'handleOrUrl', label: 'YouTube' },

        // ðŸ”’ obligan link completo
        'socials.linkedin':  { base: null,                     allowAt: false, mode: 'urlOnly',     label: 'LinkedIn' },
        'socials.facebook':  { base: null,                     allowAt: false, mode: 'urlOnly',     label: 'Facebook' },

        // otros
        'socials.website':   { base: null,                     allowAt: false, mode: 'urlOnly',     label: 'Sitio web' },
        'socials.whatsapp':  { base: null,                     allowAt: false, mode: 'whatsapp',    label: 'WhatsApp' }
      };

      let firstInvalid = null;
      const invalidLabels = [];

      Object.keys(map).forEach(name => {
        const input = formEl.querySelector(`[name="${name}"]`);
        if (!input || !input.value) return;

        const cfg = map[name];

        if (cfg.mode === 'whatsapp') {
          input.value = normalizeWhatsApp(input.value);
          return;
        }

        if (cfg.mode === 'handleOrUrl') {
          input.value = normalizeHandleOrUrl(input.value, { base: cfg.base, allowAt: cfg.allowAt });
          return;
        }

        // urlOnly: no aceptamos @usuario ni "username" pelÃ³n; solo URL (le agregamos https si falta)
        let v = input.value.trim();
        if (v.startsWith('@') || looksLikeUsername(v)) {
          if (!firstInvalid) firstInvalid = input;
          invalidLabels.push(cfg.label);
          return; // no modificar el valor; se detendrÃ¡ el submit
        }
        input.value = ensureProtocol(v);
      });

      if (invalidLabels.length) {
        return {
          ok: false,
          message: `Por favor pega el enlace completo en: ${invalidLabels.join(', ')} (no se acepta @usuario).`,
          focus: firstInvalid
        };
      }
      return { ok: true };
    }

    // === helpers originales ===
    function showMsg(text, type = 'error') {
      const styles = {
        error:  { bg: 'rgba(255,0,0,.08)',  br: '1px solid rgba(255,0,0,.28)',  color: '#ffb3b3' },
        ok:     { bg: 'rgba(0,255,0,.08)',  br: '1px solid rgba(0,255,0,.28)',  color: '#b3ffb3' },
        info:   { bg: 'rgba(255,255,255,.06)', br: '1px solid rgba(255,255,255,.12)', color: '#e9e9ef' }
      }[type];

      msgBox.style.display = 'block';
      msgBox.style.background = styles.bg;
      msgBox.style.border = styles.br;
      msgBox.style.color = styles.color;
      msgBox.textContent = text;
      msgBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function clearMsg() {
      msgBox.style.display = 'none';
      msgBox.textContent = '';
    }

    function setSubmitting(isSubmitting) {
      if (!submitBtn) return;
      if (isSubmitting) {
        submitBtn.dataset._origText = submitBtn.textContent;
        submitBtn.textContent = 'Enviandoâ€¦';
        submitBtn.disabled = true;
      } else {
        if (submitBtn.dataset._origText) submitBtn.textContent = submitBtn.dataset._origText;
        submitBtn.disabled = false;
      }
    }

    function isCreateMode() {
      return !!document.getElementById('email_confirm');
    }

    function validateEmailsClient() {
      const emailInput = document.getElementById('email');
      const confirmInput = document.getElementById('email_confirm');
      if (!confirmInput) return true;

      const email = (emailInput.value || '').trim().toLowerCase();
      const email2 = (confirmInput.value || '').trim().toLowerCase();

      if (!email || !email2) {
        showMsg('Debes ingresar ambos correos.', 'error');
        (!email ? emailInput : confirmInput).focus();
        return false;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email) || !emailRegex.test(email2)) {
        showMsg('Debes ingresar correos vÃ¡lidos (ejemplo@dominio.com).', 'error');
        confirmInput.focus();
        return false;
      }

      if (email !== email2) {
        showMsg('Los correos no coinciden. Corrige antes de continuar.', 'error');
        confirmInput.focus();
        return false;
      }
      return true;
    }

    function validateVerifyCodeClient() {
      const codeInput = document.getElementById('verify_code');
      if (!codeInput) return true;

      const code = (codeInput.value || '').trim();
      if (!/^\d{6}$/.test(code)) {
        showMsg('El cÃ³digo de verificaciÃ³n debe tener 6 dÃ­gitos.', 'error');
        codeInput.focus();
        return false;
      }
      return true;
    }

    // === listener submit ===
    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      clearMsg();

      if (isCreateMode()) {
        if (!validateEmailsClient()) return;
      } else {
        if (!validateVerifyCodeClient()) return;
      }

      // ðŸ”’ ValidaciÃ³n/normalizaciÃ³n de redes (bloquea LinkedIn/Facebook si no son links)
      const socialCheck = normalizeSocialFields(form);
      if (!socialCheck.ok) {
        showMsg(socialCheck.message, 'error');
        socialCheck.focus && socialCheck.focus.focus();
        return;
      }

      try {
        setSubmitting(true);

        const fd = new FormData(form);
        const resp = await fetch(form.action, { method: 'POST', body: fd });

        if (resp.redirected) {
          window.location.href = resp.url;
          return;
        }

        if (!resp.ok) {
          const text = (await resp.text()).trim();
          let friendly;
          if (text.includes("verificaciÃ³n invÃ¡lido")) {
            friendly = "El cÃ³digo es incorrecto. Verifica y vuelve a intentarlo.";
          } else if (text.includes("Emails no coinciden")) {
            friendly = "Los correos no coinciden. Corrige antes de continuar.";
          } else {
            friendly = text || "No se pudo guardar. Revisa los campos.";
          }

          showMsg(friendly, 'error');
          setSubmitting(false);
          return;
        }

        const html = await resp.text();
        if (/<html/i.test(html)) {
          document.open(); document.write(html); document.close();
        } else {
          showMsg('Guardado correctamente.', 'ok');
          setSubmitting(false);
        }

      } catch (err) {
        console.error(err);
        showMsg('Error de conexiÃ³n. Intenta de nuevo.', 'error');
        setSubmitting(false);
      }
    });

    // --- quitar avatar (solo cambia el texto mostrado, no los IDs)
    const btnRemoveAvatar = document.getElementById('btn-remove-avatar');
    if (btnRemoveAvatar) {
      btnRemoveAvatar.addEventListener('click', function () {
        const removeField = document.getElementById('avatar_remove');
        const fileInput = document.getElementById('avatar');
        if (removeField) removeField.value = '1';
        if (fileInput) fileInput.value = '';
        showMsg('La foto de perfil se marcarÃ¡ para eliminar al guardar.', 'info');
      });
    }

    // --- quitar logo
    const btnRemoveLogo = document.getElementById('btn-remove-logo');
    if (btnRemoveLogo) {
      btnRemoveLogo.addEventListener('click', function () {
        const removeField = document.getElementById('companyLogo_remove');
        const fileInput = document.getElementById('companyLogo');
        if (removeField) removeField.value = '1';
        if (fileInput) fileInput.value = '';
        showMsg('El logo se marcarÃ¡ para eliminar al guardar.', 'info');
      });
    }

    // resetear flags si seleccionan nuevo archivo
    const avatarInput = document.getElementById('avatar');
    if (avatarInput) {
      avatarInput.addEventListener('change', function () {
        const removeField = document.getElementById('avatar_remove');
        if (removeField) removeField.value = '0';
      });
    }
    const logoInput = document.getElementById('companyLogo');
    if (logoInput) {
      logoInput.addEventListener('change', function () {
        const removeField = document.getElementById('companyLogo_remove');
        if (removeField) removeField.value = '0';
      });
    }

    // Validaciones en cliente
    if (isCreateMode()) {
      if (!validateEmailsClient()) return;
      const accept = document.getElementById('accept_terms');
      if (!accept || !accept.checked) {
        showMsg('Debes aceptar los TÃ©rminos y Condiciones para continuar.', 'error');
        accept && accept.focus();
        return;
      }
    }

  })();
  </script>

</body>
</html>
